{% extends 'media_library/base.html' %}

{% block title %}{{ media_item.title }} - Медиатека{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <span class="badge {% if media_type == 'book' %}bg-primary{% elif media_type == 'movie' %}bg-success{% else %}bg-info{% endif %}">
                    {% if media_type == 'book' %}Книга
                    {% elif media_type == 'movie' %}Фильм
                    {% else %}Аудиокнига{% endif %}
                </span>
                
                <h1 class="card-title">{{ media_item.title }}</h1>
                <p class="card-text"><strong>Автор/Режиссер:</strong>
                    {% if media_type == 'movie' %}
                        {{ media_item.director }}
                    {% else %}
                        {{ media_item.creator }}
                    {% endif %}
                </p>
                <p class="card-text"><strong>Дата публикации:</strong> {{ media_item.publication_date }}</p>
                
                <!-- Специфичные поля для каждого типа -->
                {% if media_type == 'book' %}
                <p class="card-text"><strong>ISBN:</strong> {{ media_item.isbn }}</p>
                <p class="card-text"><strong>Количество страниц:</strong> {{ media_item.page_count }}</p>
                {% if media_item.is_borrowed %}
                <p class="card-text"><strong>Статус:</strong> <span class="badge bg-warning">В аренде у {{ media_item.borrowed_by }}</span></p>
                {% endif %}
                
                {% elif media_type == 'movie' %}
                <p class="card-text"><strong>Длительность:</strong> {{ media_item.duration }} минут</p>
                <p class="card-text"><strong>Формат:</strong> {{ media_item.format }}</p>
                <p class="card-text"><strong>Режиссер:</strong> {{ media_item.director }}</p>
                <p class="card-text"><strong>Жанр:</strong> {{ media_item.get_genre_display }}</p>
                
                {% elif media_type == 'audiobook' %}
                <p class="card-text"><strong>Длительность:</strong> {{ media_item.duration }} минут</p>
                <p class="card-text"><strong>Чтец:</strong> {{ media_item.narrator }}</p>
                {% if media_item.is_borrowed %}
                <p class="card-text"><strong>Статус:</strong> <span class="badge bg-warning">В аренде у {{ media_item.borrowed_by }}</span></p>
                {% endif %}
                {% endif %}
                
                <div class="mt-4">
                    <h4>Действия:</h4>
                    <div class="action-buttons">
                        {% for action_code, action_name, btn_class in available_actions %}
                        <button onclick="performAction('{{ media_type }}', {{ media_item.id }}, '{{ action_code }}')" 
                                class="btn {{ btn_class }} me-2 mb-2">
                            {{ action_name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                {% if media_type == 'movie' %}
                <!-- Рейтинг и отзывы -->
                <div class="mt-4">
                    <h4>Рейтинг: {% if avg_rating %}{{ avg_rating|floatformat:1 }}{% else %}—{% endif %}</h4>

                    <div class="mb-3">
                        <h5>Отзывы:</h5>
                        <ul class="list-group mb-3">
                            {% if reviews %}
                                {% for r in reviews %}
                                <li class="list-group-item">
                                    <strong>{{ r.rating }}/5</strong> — {{ r.comment }}
                                    <div class="text-muted small">{{ r.created_at }}</div>
                                </li>
                                {% endfor %}
                            {% else %}
                                <li class="list-group-item text-muted">Нет отзывов</li>
                            {% endif %}
                        </ul>
                    </div>

                    {% if can_add_review %}
                    <form method="post" action="{% url 'media_library:media_add_review' media_type=media_type pk=media_item.pk %}">
                        {% csrf_token %}
                        <div class="row g-2 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label">Оценка</label>
                                <select name="rating" class="form-select">
                                    <option value="">—</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Комментарий</label>
                                <input name="comment" class="form-control" placeholder="Напишите отзыв (необязательно)">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary">Оставить отзыв</button>
                            </div>
                        </div>
                    </form>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{% url 'media_library:media_list' %}" class="btn btn-outline-secondary">← Назад к списку</a>
</div>
{% endblock %}